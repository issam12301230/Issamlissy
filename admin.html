<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>لوحة التحكم - Admin</title>
<style>
  :root{--accent:#00ff99;--dark:#002900}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background: linear-gradient(120deg,#003a1a,#006633);color:#fff;display:flex;flex-direction:column;align-items:center;padding:18px}
  .card{width:100%;max-width:820px;background:rgba(0,0,0,0.22);padding:14px;border-radius:12px;margin:10px 0}
  label{display:block;margin-top:8px;font-weight:700}
  input,textarea,button{width:100%;padding:10px;border-radius:8px;border:none;box-sizing:border-box}
  .row{display:flex;gap:10px}
  .small{width:140px}
  .post{background:rgba(0,0,0,0.45);padding:10px;margin:10px;border-radius:10px;position:relative}
  .delete-btn{position:absolute;top:10px;right:10px;background:#ff4d4d;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
  .user-item{padding:8px;background:rgba(255,255,255,0.06);border-radius:8px;margin:6px 0;cursor:pointer}
</style>
</head>
<body>

<h2>لوحة التحكم - النشر والإدارة</h2>

<div id="loginPanel" class="card">
  <label>الاسم</label>
  <input id="username" placeholder="اسمك هنا">
  <label>كلمة المرور</label>
  <input id="userpass" type="password" placeholder="أدخل كلمة المرور">
  <div style="margin-top:10px">
    <button id="loginBtn">دخول</button>
  </div>
  <p style="opacity:0.8;margin-top:8px;font-size:13px">كلمة المرور الحالية للتجربة: <b>1234</b></p>
</div>

<div id="panel" style="display:none; width:100%;max-width:900px">
  <div class="card">
    <h3>نشر جديد</h3>
    <label>نص المنشور</label>
    <textarea id="postText" rows="4" placeholder="اكتب ما تريد"></textarea>
    <label>رابط الصورة (اختياري)</label>
    <input id="postImg" placeholder="https://.../image.jpg">
    <div style="margin-top:10px"><button id="postBtn">نشر</button></div>
  </div>

  <div class="card">
    <h3>الأسماء المسجلة بالدخول (اضغط لحذف بعد إدخال كلمة حذف المدير)</h3>
    <div id="userList"></div>
  </div>

  <div class="card">
    <h3>البلاغات الواردة</h3>
    <div id="reportList"></div>
  </div>

  <div class="card">
    <h3>المنشورات (حذف مباشرة)</h3>
    <div id="postsContainer"></div>
  </div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAYYHodH9RefC7ToNj4SI3nFAtOc6B36CU",
  authDomain: "issam-b3280.firebaseapp.com",
  projectId: "issam-b3280",
  storageBucket: "issam-b3280.firebasestorage.app",
  messagingSenderId: "767266617594",
  appId: "1:767266617594:web:4b04e0aeffe4ccc0903143",
  measurementId: "G-FVZEEHQYGL"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* كلمات المرور المختبرة */
const publishPassword = '1234';
const adminDeletePass = '12345678910';
let currentUser = null;

/* عناصر DOM */
const loginPanel = document.getElementById('loginPanel');
const panel = document.getElementById('panel');
const loginBtn = document.getElementById('loginBtn');
const postBtn = document.getElementById('postBtn');

loginBtn.addEventListener('click', loginUser);
postBtn.addEventListener('click', addPost);

/* تسجيل الدخول */
function loginUser(){
  const name = document.getElementById('username').value.trim();
  const pass = document.getElementById('userpass').value.trim();
  if(!name || !pass){ alert('أدخل الاسم وكلمة المرور'); return; }
  if(pass !== publishPassword){ alert('كلمة المرور خاطئة'); return; }
  currentUser = name;
  loginPanel.style.display = 'none';
  panel.style.display = 'block';
  // سجل المستخدم في قاعدة users
  db.collection('users').doc(currentUser).set({ name: currentUser, ts: Date.now() });
  startListeners();
  alert('تم الدخول بنجاح — مرحباً ' + currentUser);
}

/* نشر */
function addPost(){
  const text = document.getElementById('postText').value.trim();
  const img = document.getElementById('postImg').value.trim();
  if(!text){ alert('أدخل نص المنشور'); return; }
  db.collection('posts').add({ text, img, user: currentUser, time: Date.now() })
    .then(()=>{ document.getElementById('postText').value=''; document.getElementById('postImg').value=''; })
    .catch(e=>{ console.error(e); alert('خطأ في النشر'); });
}

/* شغّل الليسنرات المباشرة */
function startListeners(){
  // المنشورات
  db.collection('posts').orderBy('time','desc').onSnapshot(snap=>{
    const container = document.getElementById('postsContainer'); container.innerHTML='';
    snap.forEach(docSnap=>{
      const p = docSnap.data();
      const el = document.createElement('div'); el.className='post';
      el.innerHTML = `<div style="opacity:0.9;font-size:13px">${p.user} • ${new Date(p.time).toLocaleString()}</div>
                      <div style="margin-top:6px">${escapeHtml(p.text)}</div>
                      ${p.img? `<img src="${p.img}" style="max-width:100%;border-radius:8px;margin-top:8px">` : ''}`;
      const del = document.createElement('button'); del.className='delete-btn'; del.textContent='حذف';
      del.onclick = ()=> {
        if(confirm('هل تريد حذف هذا المنشور؟')) db.collection('posts').doc(docSnap.id).delete();
      };
      el.appendChild(del);
      container.appendChild(el);
    });
  });

  // المستخدمون
  db.collection('users').onSnapshot(snap=>{
    const ulist = document.getElementById('userList'); ulist.innerHTML='';
    snap.forEach(docSnap=>{
      const u = docSnap.data();
      const d = document.createElement('div'); d.className='user-item'; d.innerText = u.name;
      d.onclick = ()=>{
        const pass = prompt('أدخل كلمة مرور حذف المستخدم:');
        if(pass === adminDeletePass){
          db.collection('users').doc(docSnap.id).delete();
        } else alert('كلمة مرور خاطئة.');
      };
      ulist.appendChild(d);
    });
  });

  // البلاغات
  db.collection('reports').orderBy('time','desc').onSnapshot(snap=>{
    const rdiv = document.getElementById('reportList'); rdiv.innerHTML='';
    snap.forEach(docSnap=>{
      const r = docSnap.data();
      const el = document.createElement('div'); el.style.padding='8px'; el.style.margin='6px 0'; el.style.background='rgba(255,255,255,0.04)';
      el.innerHTML = `<b>${r.postUser}</b>: ${escapeHtml(r.text)} <br>السبب: ${escapeHtml(r.reason)} <br><small>${new Date(r.time).toLocaleString()}</small>`;
      rdiv.appendChild(el);
    });
  });
}

/* مساعدة لتأمين النص */
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
</script>
</body>
</html>
